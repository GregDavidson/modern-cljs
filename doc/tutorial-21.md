# Tutorial 21 - Learn by Contributing (Part 2)

In the [previous tutorial][1] while starting to learn the [Enfocus][2]
lib we ended up by collaborating with [Creighton Kirkendall][3] in
deeply refactoring both the directories layout and the `project.clj`
configuration of his very interesting and promising lib with the
intention of preparing it to be unit tested by using the
[clojurescript.test][4] lib. 

## Introduction

The first instict would be now to go on in this tutorial by starting
to implement few unit tests for the `enfocus` lib based on the
[clojurescript.test][4] unit testing lib. But we are going to postpone
this topic to a next tutorial for a couple of reasons:

* first, because to be able to define any unit tests for the `Enfocus`
  lib, we should at least know its basic use cases which we still have
  to learn about;
* second, because we want to anticipate few `project.clj` settings
  which affect the packaging of the `Enfocus` lib in a `jar` artifact
  to be published.

Therefore, in this tuturial we're going to improving even more the
directories layout and the `project.clj` file of the `Enfocus` lib by:

* preparing the lib to be correctly packaged in a `jar`;
* intrumenting the lib with [piggieback][5] lib;
* extending the application of the separations of concerns principle
  to the static resources of the project;
* publishing the modified `Enfocus` lib on [clojars][6];
* creating a very simple project which depends on the refactored
  `Enfocus` lib.

### Enfocus Packaging

In the [previous tutorial][1], while substituting the `cljx` plugin
with the `:crossovers` option of the `cljsbuild` plugin, we changed
the `:hooks [cljx.hooks]` setting with the `:hooks
[leiningen.cljsbuild]` setting as well.

This way the `cljsbuild` tasks have been hooked to the main `lein`
tasks. That's why we were able to issue the `lein do clean, compile`
chain of commands instead of the more verbose `lein do clean,
cljsbuild clean, cljsbuild once` one.

Following is the list of the supported `lein` main tasks when
`cljsbuild` is hooked to it:

```bash
* lein clean # calls lein cljsbuild clean task
* lein compile #call lein cljsbuild once task
* lein test # call lein cljsbuild test task
* lein jar
```

The first three hooked `lein` tasks have already been used and you
know about them. Let's now try the `lein jar` task by first take a
look at the associated help:

```bash
lein help jar
Package up all the project's files into a jar file.

Create a $PROJECT-$VERSION.jar file containing project's source files as well
as .class files if applicable. If project.clj contains a :main key, the -main
function in that namespace will be used as the main-class for executable jar.

With an argument, the jar will be built with an alternate main.

Arguments: ([main] [])
```

Good. the `lein jar` tasks seems to be exactly what we need to package
the `Enfocus` lib in a `jar` to be deployed and published on
[clojars][6].

Let's use it.

```bash
lein do clean, compile, jar
Deleting files generated by lein-cljsbuild.
Compiling ClojureScript.
...
Successfully compiled "resources/public/js/whitespace.js" in 8.692111 seconds.
Compiling ClojureScript.
Created /Users/mimmo/devel/enfocus/target/enfocus-2.0.1-SNAPSHOT.jar
```

Now take a look at content of the `enfocus-2.0.1-SNAPSHOT.jar` jar
package.

```bash
jar tvf target/enfocus-2.0.1-SNAPSHOT.jar
    92 Fri Oct 11 15:57:26 CEST 2013 META-INF/MANIFEST.MF
  3579 Fri Oct 11 15:57:26 CEST 2013 META-INF/maven/enfocus/enfocus/pom.xml
   152 Fri Oct 11 15:57:26 CEST 2013 META-INF/maven/enfocus/enfocus/pom.properties
  1875 Fri Oct 11 15:57:26 CEST 2013 META-INF/leiningen/enfocus/enfocus/project.clj
  1875 Fri Oct 11 15:57:26 CEST 2013 project.clj
 11526 Fri Oct 11 15:57:26 CEST 2013 META-INF/leiningen/enfocus/enfocus/README.textile
118087 Fri Oct 11 15:57:06 CEST 2013 public/js/advanced.js
728197 Fri Oct 11 15:56:36 CEST 2013 public/js/simple.js
1330646 Fri Oct 11 15:57:14 CEST 2013 public/js/whitespace.js
  1928 Fri Oct 11 10:26:10 CEST 2013 enfocus/enlive/syntax.clj
  4386 Fri Oct 11 10:26:10 CEST 2013 enfocus/macros.clj
```

Oh my God. The emitted jar contains all the JS files generated by the
`cljsbuild` builds and the CLJ source files too, but it does not
contain any CLJS source file.

Aside from the `META/INF` stuff and `project.clj` file, we would like
to package into the `Enfocus` jar only the source files and resources
needed by a third party developer to use the lib itself. More
precisely:

* the CLJ source files: `macros.clj` and `syntax.clj`
* the CLJS source files: `syntax.cljs`, `core.cljs`, `events.cljs` and
  `effects.cljs`.

A third party developer does not need any static resources (e.g. the
JS files generated by `cljsbuild`) to be able to use the `Enfocus`
lib, because those resources are used for testing purpouse only.

### Fill the package with the right content

We'll go on step by step.

#### Include the CLJS sources generated by `:crossovers`

To include the `syntax.cljs` file generated by the `:crossovers`
option we need to add to the `cljsbuild` section the `:crossover-jar
true` setting as well.

```clj
(defproject enfocus "2.0.1-SNAPSHOT"
  ...
  :cljsbuild
  {...
   :crossover-jar true
   ...})
```

Run the `lein jar` command again and inspect the emitted jar package.

```bash
lein jar
Compiling ClojureScript.
Created /Users/mimmo/devel/enfocus/target/enfocus-2.0.1-SNAPSHOT.jar
```

```bash
jar tvf target/enfocus-2.0.1-SNAPSHOT.jar
...
  2105 Fri Oct 11 16:46:00 CEST 2013 enfocus/enlive/syntax.cljs
```

The `syntax.cljs` source is now included in the jar package. First
problem solved.

#### Include all the CLJS sources

The `cljsbuild` plugin offers a `:jar true` option which is settable
in each `build` in the `:builds` section. This is very similar to the
just used `:crossover-jar` option.

```clj
(defproject enfocus "2.0.1-SNAPSHOT"
  ...
  :cljsbuild
  {...
   :builds {:whitespace
            {:source-paths ["src/cljs" "test/cljs"]
             :jar true
             ...}}})
```

Here we added the `:jar true` setting to the `:whitespace` build only,
but we could have choosen any of the other builds as well, because
they all look at the same `:source-paths` option configuration to
compile down their JS files.

Run the `lein jar` command again and inspect the emitted jar package.

```bash
lein jar
Compiling ClojureScript.
Created /Users/mimmo/devel/enfocus/target/enfocus-2.0.1-SNAPSHOT.jar
```

```bash
jar tvf target/enfocus-2.0.1-SNAPSHOT.jar
...
118087 Fri Oct 11 15:57:06 CEST 2013 public/js/advanced.js
728197 Fri Oct 11 15:56:36 CEST 2013 public/js/simple.js
1330646 Fri Oct 11 15:57:14 CEST 2013 public/js/whitespace.js
  1928 Fri Oct 11 10:26:10 CEST 2013 enfocus/enlive/syntax.clj
  4386 Fri Oct 11 10:26:10 CEST 2013 enfocus/macros.clj
  2105 Fri Oct 11 17:08:26 CEST 2013 enfocus/enlive/syntax.cljs
 23336 Fri Oct 11 17:08:26 CEST 2013 enfocus/core.cljs
  4247 Fri Oct 11 17:08:26 CEST 2013 enfocus/events.cljs
  6851 Fri Oct 11 17:08:26 CEST 2013 enfocus/effects.cljs
   168 Fri Oct 11 17:08:26 CEST 2013 enfocus/core_test.cljs
```

That's better than before, but still unsatisfactory. As you see, even
if all the `cljs` sources are now included in the jar package, the JS
sources are still packaged in the `jar` and the `core_test.cljs`
fictional unit test as well.

#### Remove any generated JS sources

Let's take care of the generated JS first.

At the beginning of the [previous tutorial][1] we have shown the
*quasi standard directories layout* of a mixed CLJ/CLJS project and
talked a bit about the separation of concerns principle applied to the
static resources of a project.

In a CLJ/CLJS lib any static resource needed by a third party
developer to use the lib itself has to be parked in the `resources`
directory. Instead, any static resource needed during the
developing/testing phase of a lib has to be saved in the
`dev-resources` directory. This is because the `lein jar` command will
only include into the generated `jar` the resources registered in the
`resources` directory.

In the `Enfocus` project all the emitted JS files are used for testing
purpouse only, not for releasing the lib to third parties.

Let's then rename the `resources` directory as `dev-resources` and
modify any referece to it in the `project.clj`.

```bash
mv resources dev-resources
```

```clj
(defproject enfocus "2.0.1-SNAPSHOT"
  ...
  {...
   :builds {:whitespace
            {...
             :compiler
             {:output-to "dev-resources/public/js/whitespace.js"
              ...}}
             
            :simple 
            {...
			 :compiler
             {:output-to "dev-resources/public/js/simple.js"
              ...}}
             
            :advanced
            {...
             :compiler
             {:output-to "dev-resources/public/js/advanced.js"
              ...}}}
   :test-commands {"whitespace"
                   ["phantomjs" :runner "dev-resources/public/js/whitespace.js"]
                   
                   "simple" 
                   ["phantomjs" :runner "dev-resources/public/js/simple.js"]
                   
                   "advanced"
                   ["phantomjs" :runner "dev-resources/public/js/advanced.js"]}})
```

As you see, each `:output-to` and `:test-commands` setting are now
referecing the `dev-resources` directory.

Run the `lein jar` task again and inspect the emitted jar package.

```bash
lein jar
Compiling ClojureScript.
Created /Users/mimmo/devel/enfocus/target/enfocus-2.0.1-SNAPSHOT.jar
```

```bash
jar tvf target/enfocus-2.0.1-SNAPSHOT.jar
...
  1928 Fri Oct 11 10:26:10 CEST 2013 enfocus/enlive/syntax.clj
  4386 Fri Oct 11 10:26:10 CEST 2013 enfocus/macros.clj
  2105 Fri Oct 11 19:56:20 CEST 2013 enfocus/enlive/syntax.cljs
 23336 Fri Oct 11 19:56:20 CEST 2013 enfocus/core.cljs
  4247 Fri Oct 11 19:56:20 CEST 2013 enfocus/events.cljs
  6851 Fri Oct 11 19:56:20 CEST 2013 enfocus/effects.cljs
   168 Fri Oct 11 19:56:20 CEST 2013 enfocus/core_test.cljs
```

The JS sources are not included in the `jar` anymore. Much better than
before. We now have to find a way to exclude the `core_test.cljs`
fictional unit test.

#### Remove unit tests

The `core_test.cljs` unit test is included in the `jar` package
because the `:whitespace` build that we have selected to be augumented
with the `:jar true` setting still has the `"test/cljs"` directory set
as value in the `:source-paths` option.

But wait minute, if we remove the `"test/cljs"` directory from the
`:whitespace` build, we will not be able to test it anymore. The
easier way to solve this problem is to copy the build with a new name,
remove the `:jar true` setting from the `:whitespace` build, remove
the `"test/cljs"` directory from the `:source-paths` option of the
newly copied build and finally rename the JS file to be generated.

```clj
(defproject enfocus "2.0.1-SNAPSHOT"
  ...
   :cljsbuild
  {...
   :builds {:deploy
            {:source-paths ["src/cljs"]
             :jar true
             :compiler
             {:output-to "dev-resources/public/js/deploy.js"
              :optimizations :whitespace
              :pretty-print true}}
            ...}})
```

We now have four builds. Three of them are used for testing purpouse
only and one of them, the `:deploy` one, is used by the `lein jar`
tasks to include the `Enfocus` CLJS sources in the `jar` package.

Run the `lein jar` task again and inspect the emitted jar package.

```bash
lein jar
Compiling ClojureScript.
Compiling "dev-resources/public/js/deploy.js" from ["src/cljs"]...
Successfully compiled "dev-resources/public/js/deploy.js" in 38.729721 seconds.
Created /Users/mimmo/devel/enfocus/target/enfocus-2.0.1-SNAPSHOT.jar
```

> NOTE 1: This time the `lein jar` task runs the compilation of the new
> `:deploy` build as well.

```bash
jar tvf target/enfocus-2.0.1-SNAPSHOT.jar
    92 Fri Oct 11 20:16:10 CEST 2013 META-INF/MANIFEST.MF
  3579 Fri Oct 11 20:16:10 CEST 2013 META-INF/maven/enfocus/enfocus/pom.xml
   152 Fri Oct 11 20:16:10 CEST 2013 META-INF/maven/enfocus/enfocus/pom.properties
  2170 Fri Oct 11 20:16:10 CEST 2013 META-INF/leiningen/enfocus/enfocus/project.clj
  2170 Fri Oct 11 20:16:10 CEST 2013 project.clj
 11526 Fri Oct 11 20:16:10 CEST 2013 META-INF/leiningen/enfocus/enfocus/README.textile
  1928 Fri Oct 11 10:26:10 CEST 2013 enfocus/enlive/syntax.clj
  4386 Fri Oct 11 10:26:10 CEST 2013 enfocus/macros.clj
  2105 Fri Oct 11 20:16:10 CEST 2013 enfocus/enlive/syntax.cljs
 23336 Fri Oct 11 20:16:10 CEST 2013 enfocus/core.cljs
  4247 Fri Oct 11 20:16:10 CEST 2013 enfocus/events.cljs
  6851 Fri Oct 11 20:16:10 CEST 2013 enfocus/effects.cljs
```

Great. We now have a jar package which includes exactly what is needed
by a third party developer to use the `Enfocus` artifact.

## Instrument Enfocus

As a next step we'd like to instrument `Enfocus` with the
[piggieback][5] lib introduced in the
[Tutorial 19 - A survival guide for livin' on the edge][7] by adding
it to the `:dev` profile. We're also going to exploit this opportunity
to move few stuff to the `:dev` profile as well.

```clj
(defproject org.clojars.magomimmo/enfocus "2.0.1-SNAPSHOT"
  ...
  ;; piggieback requires a 2.2.0 minimun lein version
  :min-lein-version "2.2.0"
  ...
  ;; we moved the clojurescript.test lib into the dev profile
  :dependencies [[org.clojure/clojure "1.5.1"]
                 [org.clojure/clojurescript "0.0-1913"]
                 [domina "1.0.2"]
                 [org.jsoup/jsoup "1.7.2"]]
  ...
    
  :cljsbuild
  {:crossovers [enfocus.enlive.syntax]
   :crossover-jar true
   ;; we moved all the builds to support unit testing into the dev profile
   :builds {:deploy
            {:source-paths ["src/cljs"]
             :jar true
             :compiler
             {:output-to "dev-resources/public/js/deploy.js"
              :optimizations :whitespace
              :pretty-print true}}}}

  :profiles {:dev {:dependencies [[com.cemerick/piggieback "0.1.0"]]
                   :plugins [[com.cemerick/clojurescript.test "0.1.0"]]

                   :cljsbuild 
                   {:builds {:whitespace
                             {:source-paths ["src/cljs" "test/cljs"]
                              :compiler
                              {:output-to "dev-resources/public/js/whitespace.js"
                               :optimizations :whitespace
                               :pretty-print true}}

                             :simple
                             {:source-paths ["src/cljs" "test/cljs"]
                              :compiler
                              {:output-to "dev-resources/public/js/simple.js"
                               :optimizations :simple
                               :pretty-print false}}

                             :advanced
                             {:source-paths ["src/cljs" "test/cljs"]
                              :compiler
                              {:output-to "dev-resources/public/js/advanced.js"
                               :optimizations :advanced
                               :pretty-print false}}}

                    :test-commands {"whitespace"
                                    ["phantomjs" :runner "dev-resources/public/js/whitespace.js"]
                   
                                    "simple" 
                                    ["phantomjs" :runner "dev-resources/public/js/simple.js"]
                   
                                    "advanced"
                                    ["phantomjs" :runner "dev-resources/public/js/advanced.js"]}}
                               
                   :repl-options {:nrepl-middleware [cemerick.piggieback/wrap-cljs-repl]}
                   :injections [(require '[cljs.repl.browser :as brepl]
                                         '[cemerick.piggieback :as pb])
                                (defn browser-repl []
                                  (pb/cljs-repl :repl-env
                                                (brepl/repl-env :port 9000)))]}})
```

First we augumented the project with the `:dev` profile and we also
added to it the `piggieback` instrumentation which requires the
`:repl-options` and the `:injections` setting as well.

Next we moved the `clojurescript.test` lib into the `:plugins` option
of the `:dev` profile.

Finally we moved to the `:dev` profile the builds used for testing
purpose only and the corresponding test-commands as well.

> NOTE 2: We added the `org.clojars.magomimmo` group-id to deploy the
> `Enfocus` aritifact to clojars by respecting its guide lines.

> NOTE 3: Because of `piggieback` requirements, we needed to update
> the `min-lein-version` setting to `"2.2.0"`.

> NOTE 4: For a more detailed explanation of the `piggieback`
> instrumentation and the addition of the `:profiles` setting, see the
> [Tutorial 18 - Housekeeping][8] tutorial.

### Light the fire

We can now try to run everything from scratch to verity if the
changes altered the result.

```bash
lein do clean, compile, jar
Deleting files generated by lein-cljsbuild.
Compiling ClojureScript.
...
Successfully compiled "dev-resources/public/js/whitespace.js" in 10.631821 seconds.
...
Compiling "dev-resources/public/js/simple.js" from ["src/cljs" "test/cljs"]...
...
Successfully compiled "dev-resources/public/js/simple.js" in 6.108886 seconds.
...
Successfully compiled "dev-resources/public/js/deploy.js" in 2.982961 seconds.
...
Created /Users/mimmo/Developer/enfocus/target/enfocus-2.0.1-SNAPSHOT.jar
```

```bash
jar tvf target/enfocus-2.0.1-SNAPSHOT.jar
    92 Sat Oct 12 15:39:26 CEST 2013 META-INF/MANIFEST.MF
  3805 Sat Oct 12 15:39:26 CEST 2013 META-INF/maven/org.clojars.magomimmo/enfocus/pom.xml
   166 Sat Oct 12 15:39:26 CEST 2013 META-INF/maven/org.clojars.magomimmo/enfocus/pom.properties
  3146 Sat Oct 12 15:39:26 CEST 2013 META-INF/leiningen/org.clojars.magomimmo/enfocus/project.clj
  3146 Sat Oct 12 15:39:26 CEST 2013 project.clj
 11526 Sat Oct 12 15:39:26 CEST 2013 META-INF/leiningen/org.clojars.magomimmo/enfocus/README.textile
     0 Sat Oct 12 02:35:20 CEST 2013 enfocus/
     0 Sat Oct 12 02:35:20 CEST 2013 enfocus/enlive/
  1928 Sat Oct 12 02:35:20 CEST 2013 enfocus/enlive/syntax.clj
  4386 Sat Oct 12 02:35:20 CEST 2013 enfocus/macros.clj
  2109 Sat Oct 12 15:39:26 CEST 2013 enfocus/enlive/syntax.cljs
 23336 Sat Oct 12 15:39:26 CEST 2013 enfocus/core.cljs
  4247 Sat Oct 12 15:39:26 CEST 2013 enfocus/events.cljs
  6851 Sat Oct 12 15:39:26 CEST 2013 enfocus/effects.cljs
```

Great. The project is still compiling and building the `jar` package
as expected. We should now predispose the `Enfocus` project, already
instrumented with `piggieback`, to connect itself to the browser JS
engine as we explained in the [Tutorial 18 - Housekeeping][8].

## Predispose the bREPL connection

Even if we instrumented the project with the `piggieback` lib, we
still have to do more work to be able to create a bREPL connection. As
you remember these are the step to be done:

* create and run an http server to respect the
  [same origin policy][9];
* create a cljs source file to create the bREPL connection;
* create an html page which includes the link to the JS file emitted
  by the `cljsbuild` which include the above bREPL connection;
* launch the `lein repl` task from the main project directory;
* call the `(browser-repl)` function from the CLJ REPL;
* visit the above html page;
* use the bREPL.

We're going to pospone all this stuff for later, because we first want
to deploy the revised `Enfocus` lib to `clojars` and try to use it in
a very simple new project to verify that even after all the changes we
made, the `Enfocus` lib is still working as expected.

## Deploy on clojars

Let's deploy the new `2.0.1-SNAPSHOT` artifact to `clojars`:

```bash
lein deploy clojars
No credentials found for clojars (did you mean `lein deploy clojars`?)
See `lein help deploy` for how to configure credentials.
Username: 
Password:
Wrote /Users/mimmo/Developer/enfocus/pom.xml
Compiling ClojureScript.
Created /Users/mimmo/Developer/enfocus/target/enfocus-2.0.1-SNAPSHOT.jar
Could not find metadata org.clojars.magomimmo:enfocus:2.0.1-SNAPSHOT/maven-metadata.xml in clojars (https://clojars.org/repo/)
Sending org/clojars/magomimmo/enfocus/2.0.1-SNAPSHOT/enfocus-2.0.1-20131012.134345-1.pom (4k)
    to https://clojars.org/repo/
Sending org/clojars/magomimmo/enfocus/2.0.1-SNAPSHOT/enfocus-2.0.1-20131012.134345-1.jar (21k)
    to https://clojars.org/repo/
Retrieving org/clojars/magomimmo/enfocus/maven-metadata.xml (1k)
    from https://clojars.org/repo/
Sending org/clojars/magomimmo/enfocus/2.0.1-SNAPSHOT/maven-metadata.xml (1k)
    to https://clojars.org/repo/
Sending org/clojars/magomimmo/enfocus/maven-metadata.xml (1k)
    to https://clojars.org/repo/
```

Good. It worked too.

## Test with a simple project

We did a lot of working by refactoring the directories layout of
`Enfocus` and by deeply altering its project configuration, but we did
not even touch a single line of its codebase. So, we should expect
that we can still create a very simple project which depends on the
revisited `Enfocus` lib without incurring in any trouble.

### Create a new project

First create a new lein project.

```bash
lein new hello-enfocus
cd hello-enfocus
```

Then edit its `project.clj` as follows:

```clj
(defproject hello-enfocus "0.1.0-SNAPSHOT"
  :description "FIXME: write description"
  :url "http://example.com/FIXME"
  :license {:name "Eclipse Public License"
            :url "http://www.eclipse.org/legal/epl-v10.html"}
  :min-lein-version "2.2.0"
  :source-paths ["src/clj"]
  :dependencies [[org.clojure/clojure "1.5.1"]
                 [org.clojure/clojurescript "0.0-1913"]
                 [org.clojars.magomimmo/enfocus "2.0.1-SNAPSHOT"]]
  :plugins [[lein-cljsbuild "0.3.4"]]

  :cljsbuild {:builds {:whitespace
                       {:source-paths ["src/cljs"]
                        :compiler 
                        {:output-to "resources/public/js/hello.js"
                         :optimizations :whitespace
                         :pretty-print true}}}})
```

Now reorganize the directories layout by following the *quasi standard
directories layout* we introduced at the beginning of the
[previous tutorial][1].

```bash
mkdir -p src/{cljs/hello_enfocus,clj}
mv src/hello_enfocus src/clj
```

Next create the `core.cljs` file in the `src/cljs/hello-enfocus`
directory with the following content:

```clj
(ns hello-enfocus.core
  (:require [enfocus.core :as ef]
            [enfocus.events :as events]
	    [enfocus.effects :as effects])
  (:require-macros [enfocus.macros :as em]))

(defn start [] 
  (ef/at js/document
    ["body"] (ef/content "Hello Enfocus!")))

(set! (.-onload js/window) start)
```

Then compile it as usual.

```bash
lein cljsbuild once
Compiling ClojureScript.
Retrieving org/clojars/magomimmo/enfocus/2.0.1-SNAPSHOT/enfocus-2.0.1-20131012.135716-2.pom from clojars
Retrieving org/clojars/magomimmo/enfocus/2.0.1-SNAPSHOT/enfocus-2.0.1-20131012.135716-2.jar from clojars
Compiling "resources/public/js/hello.js" from ["src/cljs"]...
Successfully compiled "resources/public/js/hello.js" in 10.468363 seconds.
```

Finally create the `hello.html` file in the `resources/public` directory
with the following content:

```html
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Hello, Enfocus!</title>
    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body>
    <!-- pointing to cljsbuild generated js file -->
    <script src="js/hello.js"></script>
</body>
</html>
```

Now open the `~/dev/hello-enfocus/resources/public/hello.html` file
in your browser and you should see the `Hello, Enfocus!` string
shown in the page.

## bREPLing with enfocus

It's now time to end the `bREPL` instrumentation of the `Enfocus`
project we started before, by adding to the `project.clj` file the
`pieggiback` lib, the `:repl-options` setting and the `:injection`
option.

The path is not going to be so direct as it was in the `modern-cljs`
project, because we started to worry about the content to be put into
the `jar` packace and the content we want to be kept out from it.

### Separation of concerns

As we explained in the [Tutorial 2][], to be able to connect a CLJS
REPL to the browser JS engine we need to setup an HTTP server. That's
because of the [same origin policy][] limitation imposed by the
browser for security reasons.

In the `Enfocus` lib the HTTPS server is going to serve reasources
used for testing purpose only and we do not want those resources to be
packaged into its `jar`.

As we learnt in the previous paragraphs of this tutorial, we can
exploit the `:dev` profile to keep separated the things to be packaged
into the `jar` from the things that are only useful for developing and
testing purpouse.

### The CLJ HTTP Server

The general setup of a CLJ based HTTP server has been explained in the
[Tutotial 3][]. *Mutatis mutandis* we should now do almost the same
thing, this time in the `:dev` profile.

First we want to add the [lein-ring][] plugin and the [compojure][]
lib to the `:dev` profile as follows:

```clj
(defproject org.clojars.magomimmo/enfocus "2.0.1-SNAPSHOT"
  ...
  :profiles {:dev {:dependencies [...
	                              [compojure "1.1.5"]]
                   
                   :plugins [...
				             [lein-ring "0.8.7"]]
                   
                   :ring {:handler enfocus.server/handler}
				   ...}})
```

Note that we also configured the `:ring` handler, even if we still
have to define it. This is the next thing to do. Ask yourself where
would you create the `server.clj` source? Not in the `src/clj/enfocus`
directory, otherwise it will be packaged in the `jar`. Consider that
we're predisposing the `ring` server to be able to create a `bREPL`
connection. And we want the `bREPL` to be able to test the `Enfocus`
lib from a REPL. So, the right place to safe the `server.clj` file is
in the `test/clj/enfocus` directory.

```bash
mkdir -p test/clj/enfocus`
```

Now create the `server.clj` file in the newly created directory and
fill it with the following content:

```clj
(ns enfocus.server
  (:use compojure.core)
  (:require [compojure.handler :as handler]
            [compojure.route :as route]
            [ring.util.response :as resp]))

(defroutes app-routes
  (GET "/" [] (resp/redirect "/connect.html"))
  (route/resources "/")
  (route/not-found "Page not found"))

(def handler
  (handler/site app-routes))
```

This is almost the exact content we already wrote in the
[Tutorial 3][]. Here we only changed the `GET` macro from returning
the `<p>Hello from Compojure!<\p>` to redirect the user to the
`connect.html` page, which brings us to the `dev-reosurces` directory.

Whatever will be the `connect.html` page content, that page can't be
saved in the `resources` directory path if we don't want it to be
included in the `jar` package. At the same time, the
`resources` directory is the default path used by the
`route/resources` to serve static resources.

Luckly, `lein` offers us an escape way by letting set a
`:resources-paths` option which allow to change that default directory
to the one we desire. Again, we are dealing with testing stuff and
therefore we're going to set this optioni in the `:dev` profile as
follows:

```clj
(defproject enfocus "2.0.1-SNAPSHOT"
  ...
  :profiles {:dev {:resources-paths ["dev-resources"]
                  ...}})
```

### The bREPL connection

We nopw have to create the CLJS code that establishes the connection
with the JS Engine of the browser. By following our old friend
*separation of concerns principle* we alreay know that we have to
create the file in the `test` codebase. But remember that we can't use
a bREPL connection with the `:advanced` optimization. For this reason
we're going to create the `connect.cljs` source file in the
`test/brepl/enfocus` directory in such a way that we can distinguish
the `:source-paths` for each build of the `cljsbuils` plugin. Here is
the content of the `connect.clj` source file.

```clj
(ns enfocus.connect
  (:require [clojure.browser.repl :as repl]))

(repl/connect "http://localhost:9000/repl")
```

### The connect page

We have setup the server and created the CLJS code that will connect
the REPL with the JS Engine of the browser. Now we have to create the
HTML page to be used as mediator for connecting the REPL to the
browser.

If you're guessing this is the `connect.html` page we were talking
about while discussing the ring server configuration, you're right.

Create the `connect.html` file in the `dev-resources/public` directory
and type the following html code.

```html
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>bREPL Connection</title>
    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body>
    <!-- pointing to a cljsbuild generated js file -->
    <script src="js/whitespace.js"></script>
</body>
</html>
```

Note the `src` of the `script` tag is the `whitespace.js` file
generated by the `whitespace` build. We could have choosen the
`simple` build as well, but not the `deploy` and neither the
`advanced` one. The `deploy` build is devoted for the jar packiging
only and the `advanced` build is notcompatible with a bREPL due to the
`:advanced` optimization option use for the compiler.

### Reflect the changes in the `project.clj`

We have now to reflect the latest intervetions into the `project.clj`,
more precisely we have to modify all the builds but the `deploy` one.

```clj
(defproject org.clojars.magomimmo/enfocus "2.0.1-SNAPSHOT"
  ...
  :profiles {:dev {...
	               :cljsbuild 
                   {:builds {:whitespace
                             {:source-paths ["src/cljs" "test/cljs" "src/brepl"]
							  ...}}
                             
                             :simple
                             {:source-paths ["src/cljs" "test/cljs" "src/brepl"]
                              ...}}
  ...}})
```

### Light the fire

We are now ready to test if everything is working as expected. First
recompile everything from scratch.

```bash
lein do clean, compile
Deleting files generated by lein-cljsbuild.
Compiling ClojureScript.
Compiling "dev-resources/public/js/whitespace.js" from ["src/cljs" "test/cljs" "src/brepl"]...
WARNING: set-print-fn! already refers to: cljs.core/set-print-fn! being replaced by: cemerick.cljs.test/set-print-fn! at line 252 file:/Users/mimmo/.m2/repository/com/cemerick/clojurescript.test/0.1.0/clojurescript.test-0.1.0.jar!/cemerick/cljs/test.cljs
WARNING: set-print-fn! already refers to: cljs.core/set-print-fn! being replaced by: cemerick.cljs.test/set-print-fn! at line 252 /Users/mimmo/Developer/enfocus/target/cljsbuild-compiler-0/cemerick/cljs/test.cljs
Successfully compiled "dev-resources/public/js/whitespace.js" in 11.446879 seconds.
Compiling "dev-resources/public/js/advanced.js" from ["src/cljs" "test/cljs"]...
WARNING: set-print-fn! already refers to: cljs.core/set-print-fn! being replaced by: cemerick.cljs.test/set-print-fn! at line 252 file:/Users/mimmo/.m2/repository/com/cemerick/clojurescript.test/0.1.0/clojurescript.test-0.1.0.jar!/cemerick/cljs/test.cljs
WARNING: set-print-fn! already refers to: cljs.core/set-print-fn! being replaced by: cemerick.cljs.test/set-print-fn! at line 252 /Users/mimmo/Developer/enfocus/target/cljsbuild-compiler-1/cemerick/cljs/test.cljs
Successfully compiled "dev-resources/public/js/advanced.js" in 13.103964 seconds.
Compiling "dev-resources/public/js/simple.js" from ["src/cljs" "test/cljs" "src/brepl"]...
WARNING: set-print-fn! already refers to: cljs.core/set-print-fn! being replaced by: cemerick.cljs.test/set-print-fn! at line 252 /Users/mimmo/Developer/enfocus/target/cljsbuild-compiler-2/cemerick/cljs/test.cljs
Successfully compiled "dev-resources/public/js/simple.js" in 6.407385 seconds.
Compiling "dev-resources/public/js/deploy.js" from ["src/cljs"]...
Successfully compiled "dev-resources/public/js/deploy.js" in 3.748136 seconds.
```

Ok. The compilation process produced the 4 expected JS file. Next run the ring server.

```bash
Giacomo-Cosenzas-iMac:enfocus mimmo$ lein ring server-headless
Compiling ClojureScript.
2013-10-13 23:15:04.615:INFO:oejs.Server:jetty-7.6.8.v20121106
2013-10-13 23:15:04.649:INFO:oejs.AbstractConnector:Started SelectChannelConnector@0.0.0.0:3000
Started server on port 3000
```

Good. It worked too. Now open a new terminal, cd into the `enfocus`
main directory and run the bREPL.

```clj

lein repl

```
which the user is redirected buy the ring server  correctly guess that 

Stay tuned for the next tutorial.


# Next Step - TO BE DONE

TO BE DONE

# License

Copyright © Mimmo Cosenza, 2012-13. Released under the Eclipse Public
License, the same as Clojure.

[1]: https://github.com/magomimmo/modern-cljs/blob/master/doc/tutorial-20.md
[2]: https://github.com/ckirkendall/enfocus
[3]: https://github.com/ckirkendall
[4]: https://github.com/cemerick/clojurescript.test
[5]: https://github.com/cemerick/piggieback 
[6]: https://clojars.org/
[7]: https://github.com/magomimmo/modern-cljs/blob/master/doc/tutorial-19.md
[8]: https://github.com/magomimmo/modern-cljs/blob/master/doc/tutorial-18.md
[9]: http://en.wikipedia.org/wiki/Same_origin_policy
[10]: https://github.com/magomimmo/modern-cljs/blob/master/doc/tutorial-03.md
